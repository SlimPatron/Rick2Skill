<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Rick2Skill</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen">
        <div class="loading-content">
            <img src="rick-happy-removebg.png" alt="Rick l√§dt" class="loading-rick">
            <h2>Rick zaubert deinen Lernpfad...</h2>
            <div class="loader"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="logo">
            <a href="index.html" style="text-decoration: none; color: inherit;">
                Rick<span class="highlight-2">2</span>Skill
            </a>
        </div>
        <div class="nav-buttons">
            <a href="index.html">Zur√ºck zur Startseite</a>
        </div>
    </nav>

    <!-- Login/Register Section -->
    <section class="auth-section">
        <div class="auth-container">
            <!-- Tab-Navigation -->
            <div class="auth-tabs">
                <button class="tab-button active" data-tab="login">Anmelden</button>
                <button class="tab-button" data-tab="register">Registrieren</button>
            </div>

            <!-- Login Form -->
            <div class="auth-form" id="login-form">
                <h2>Willkommen zur√ºck! üëã</h2>
                <p class="form-subtitle">Melde dich an und erstelle deinen Skill-Tree mit Rick</p>
                
                <form id="login">
                    <div class="form-group">
                        <label for="login-email">E-Mail</label>
                        <input type="email" id="login-email" required placeholder="deine@email.de">
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Passwort</label>
                        <input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button type="submit" class="auth-button">Anmelden</button>
                </form>
                
                <p class="form-footer">
                    <a href="#" class="forgot-password">Passwort vergessen?</a>
                </p>
            </div>

            <!-- Register Form -->
            <div class="auth-form hidden" id="register-form">
                <h2>Starte mit Rick! üöÄ</h2>
                <p class="form-subtitle">Erstelle deinen Account und beginne deine Lernreise</p>
                
                <form id="register">
                    <div class="form-group">
                        <label for="register-name">Name</label>
                        <input type="text" id="register-name" required placeholder="Dein Name">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-email">E-Mail</label>
                        <input type="email" id="register-email" required placeholder="deine@email.de">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password">Passwort</label>
                        <input type="password" id="register-password" required placeholder="Mindestens 6 Zeichen">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-password-confirm">Passwort best√§tigen</label>
                        <input type="password" id="register-password-confirm" required placeholder="Passwort wiederholen">
                    </div>
                    
                    <button type="submit" class="auth-button">Registrieren</button>
                </form>
                
                <p class="form-footer">
                    Mit der Registrierung akzeptierst du unsere <a href="#">AGB</a>
                </p>
            </div>
        </div>
    </section>

    <!-- Firebase SDK -->
    <script type="module">
      // ‚úÖ ALLE IMPORTS GANZ OBEN!
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, updateProfile } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
      
      // Firebase Config (public - security via Firestore Rules)
      const firebaseConfig = {
        apiKey: "AIzaSyDF2qsdE0bbpI_ANm5Goh0SmoWarrzOGYQ",
        authDomain: "road2skill-af55a.firebaseapp.com",
        projectId: "road2skill-af55a",
        storageBucket: "road2skill-af55a.firebasestorage.app",
        messagingSenderId: "533346184642",
        appId: "1:533346184642:web:fe1d644238b6b1ef85fa5b",
        measurementId: "G-JVTCCDR8XQ"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      window.firebaseAuth = auth;
      
      console.log('üî• Firebase connected on Login page!');

      // Tab-Switching
      const tabButtons = document.querySelectorAll('.tab-button');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tab = button.dataset.tab;
          
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
          } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
          }
        });
      });

      // ‚úÖ REGISTER FUNKTION (KORRIGIERT!)
      document.getElementById('register').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;
        
        // Passwort-Check
        if (password !== passwordConfirm) {
          alert('‚ùå Passw√∂rter stimmen nicht √ºberein!');
          return;
        }
        
        if (password.length < 6) {
          alert('‚ùå Passwort muss mindestens 6 Zeichen haben!');
          return;
        }
        
        try {
          // User erstellen
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          // ‚úÖ Name als displayName speichern
          await updateProfile(user, {
              displayName: name
          });

          console.log('‚úÖ User erstellt:', user.email);
          console.log('‚úÖ Name gespeichert:', name);
          
          // Email-Verifizierung senden
          await sendEmailVerification(user);
          console.log('üìß Verifizierungs-Email gesendet!');
          
          // ‚úÖ NEU: localStorage f√ºr neuen User l√∂schen!
          localStorage.clear();

          alert('üéâ Registrierung erfolgreich!\n\nüìß Wir haben dir eine Best√§tigungs-Email geschickt.\n\n‚ö†Ô∏è WICHTIG: Check auch deinen SPAM-Ordner!\n\nBitte √∂ffne die Email und best√§tige deinen Account.');
          
          // Zur√ºck zu Login-Tab
          document.querySelector('[data-tab="login"]').click();
          
        } catch (error) {
          console.error('‚ùå Fehler:', error);
          if (error.code === 'auth/email-already-in-use') {
            alert('‚ùå Diese Email ist bereits registriert!');
          } else {
            alert('‚ùå Fehler: ' + error.message);
          }
        }
      });

      // ‚úÖ LOGIN FUNKTION
      document.getElementById('login').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            // DEBUG: User-Info loggen
            console.log('‚úÖ Login erfolgreich:', user.email);
            console.log('üîç Email Verified:', user.emailVerified);
            console.log('üë§ Display Name:', user.displayName);
            
            // PR√úFE: Email verifiziert?
            if (!user.emailVerified) {
                console.log('‚ùå Email NICHT verifiziert');
                alert('‚ö†Ô∏è Bitte best√§tige zuerst deine E-Mail-Adresse!\n\nSchau in deinem Posteingang nach der Best√§tigungs-Email.');
                return;
            }
            
            console.log('‚úÖ Email verifiziert!');
            
            // Check Onboarding Status
            const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
            console.log('üì¶ hasSeenOnboarding:', hasSeenOnboarding);
            
            if (!hasSeenOnboarding) {
                console.log('üìö ‚Üí Onboarding');
                window.location.href = 'onboarding.html';
            } else {
                console.log('üëã ‚Üí Dashboard');
                window.location.href = 'dashboard.html';
            }
            
        } catch (error) {
          console.error('‚ùå Login Fehler:', error);
          if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
            alert('‚ùå Falsche Email oder Passwort!');
          } else {
            alert('‚ùå Fehler: ' + error.message);
          }
        }
      });
    </script>
    
    <script>
        // Verstecke Loading Screen nach 500ms
        setTimeout(() => {
            const loading = document.querySelector('.loading-screen');
            if (loading) loading.style.display = 'none';
        }, 500);
    </script>
</body>
</html>
